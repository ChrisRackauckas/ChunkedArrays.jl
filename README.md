# ChunkedArrays.jl

[![Build Status](https://travis-ci.org/ChrisRackauckas/ChunkedArrays.jl.svg?branch=master)](https://travis-ci.org/ChrisRackauckas/ChunkedArrays.jl) [![Build status](https://ci.appveyor.com/api/projects/status/2fm6c86aelajy7gc?svg=true)](https://ci.appveyor.com/project/ChrisRackauckas/chunkedarrays-jl)


ChunkedArrays.jl is a package for increasing the performance of arrays generated
inside of loops. Some basic benchmarks show chunked arrays being almost 2x
as fast as naive approaches. One use case for this is using random numbers in
a loop. It's well known that for many reasons (including SIMD) that generating
1000 random number generators at once using `rand(1000)` is faster than generating
1000 random numbers in separate calls of `rand()`. ChunkedArrays allows you to
generate your arrays in larger amounts, but provides a convenient wrapper to hide the
details. Also included is the ability to generate the next buffer in parallel,
which allows you to utilize your array chunk and have it replaced with a new
chunk generated by a different process, maximizing efficiency.

# Installation

To install the package, simply use

```julia
Pkg.add("ChunkedArrays")
using ChunkedArrays
```

# Using the Package

You can define a ChunkedArray in one of the three forms:

```julia
ChunkedArray(chunkfunc::Function,bufferSize::Int=BUFFER_SIZE_DEFAULT,T::Type=Float64;parallel=PARALLEL_DEFAULT)
ChunkedArray(chunkfunc::Function,outputSize::NTuple,bufferSize::Int=BUFFER_SIZE_DEFAULT,T::Type=Float64;parallel=PARALLEL_DEFAULT)
ChunkedArray(chunkfunc,randPrototype::AbstractArray,bufferSize=BUFFER_SIZE_DEFAULT;parallel=PARALLEL_DEFAULT)
```

Then, to generate the next value in the array, you use the `next` function like:

```julia
next(chunked)
```

# Examples

Let's say for example we wished to generate a bunch of standard normal random
numbers in a loop. The naive way to do this is via

```julia
j=0.0
for i = 1:loopSize
  j += randn()
end
```

To use a ChunkedArray which outputs standard normal random numbers, we would use
the definition the following:

```julia
chunkRand = ChunkedArray(randn)
j=0.0
for i = 1:loopSize
  j += next(chunkRand)
end
```

This uses the constructor `ChunkedArray(chunkfunc::Function,bufferSize::Int=BUFFER_SIZE_DEFAULT,T::Type=Float64,parallel=PARALLEL_DEFAULT)`
which has a buffer size of 1000 and uses parallel generation. Note that you
do not need to be running multiple processes for parallel generation to work
(and it will still speed up in most cases due to magic). If we instead wished
to generate `randn(4,2)` each time in the loop, we can specify the dimensions:

```julia
chunkRand = ChunkedArray(randn,(4,2))
j=[0 0
   0 0
   0 0
   0 0]
for i = 1:loopSize
  j += next(chunkRand)
end
```

or simply give it a prototype:

```julia
j=[0 0
   0 0
   0 0
   0 0]
chunkRand = ChunkedArray(randn,j)
for i = 1:loopSize
  j += next(chunkRand)
end
```

and it will generate standard normals of `similar(j)`.

# Benchmarks

These benchmarks can be found in the test folder.

```julia
const loopSize = 1000
const buffSize = 100
const numRuns = 400
Test Results For Average Time:
One-by-one:                             0.00042966970000000006
Thousand-by-Thousand:                   0.00023297742499999997
Altogether:                             0.00034394069999999985
Hundred-by-hundred:                     0.00017033829999999996
Take at Beginning:                      0.0002823700749999999
Pre-made Rands:                         0.000126215025
Chunked Rands Premade:                  0.00015799929999999997
Chunked Rands 100 buffer:               0.000101266225
Chunked Rands Direct:                   0.00014037630000000005
Chunked Rands Max buffer:               0.000102320075
Parallel Chunked Rands 100 buffer:      0.000192345075

const loopSize = 100000
const buffSize = 1000
const numRuns = 400
Test Results For Average Time:
One-by-one:                             0.01616514919749999
Thousand-by-Thousand:                   0.02157321027
Altogether:                             0.021144474409999975
Hundred-by-hundred:                     0.020440966562499992
Take at Beginning:                      0.021992810439999982
Pre-made Rands:                         0.018754385990000007
Chunked Rands Premade:                  0.012083974932500005
Chunked Rands 1000 buffer:              0.013059985279999993
Chunked Rands Direct:                   0.014707403045000003
Chunked Rands Max buffer:               0.013439485149999994
Parallel Chunked Rands 1000 buffer:     0.011821751972499999
```
